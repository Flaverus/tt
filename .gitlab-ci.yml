stages:
  - validate
  - trigger
  - notify

workflow:
  rules:
    - if: $CI_COMMIT_BRANCH
      when: always

variables:
  PROJECT_NAME: "temperature-tracker"

# Template for common trigger configuration
.trigger_template: &trigger_template
  stage: trigger
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" # needed otherwise downstream pipelines are not triggered in MRs
      when: always
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: always
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      when: always

validate_runner: # run always to ensure runner is working
  stage: validate
  script:
    - echo "âœ… Runner is operational."
  rules:
    - when: always
    

# Trigger frontend pipeline
trigger_frontend_web_pipeline:
  <<: *trigger_template
  trigger:
    include:
      - local: 'code/frontend_web/.gitlab-ci.yml'
    strategy: depend

trigger_backend_web_pipeline:
  <<: *trigger_template
  trigger:
    include:
      - local: 'code/backend_web/.backend-web-ci.yml'
    strategy: depend

trigger_embedded_sensor_pipeline:
  <<: *trigger_template
  trigger:
    include:
      - local: 'code/embedded_sensor/.gitlab/.gitlab-ci.yml'
    strategy: depend

# Trigger backend_broker pipeline
trigger_backend_broker_pipeline:
  <<: *trigger_template
  trigger:
    include:
      - local: "code/backend_broker/.gitlab-ci.yml"
    strategy: depend

##########################################
# ToDO Add other pipelines as needed
##########################################


# Notification job for pipeline completion
pipeline_notification:
  stage: notify
  image: alpine:latest
  script: |
    echo "ðŸŽ‰ All pipeline components completed successfully!"
    echo "Project: $PROJECT_NAME"
    echo "Branch: $CI_COMMIT_BRANCH"
    echo "Commit: $CI_COMMIT_SHA"
    echo "Pipeline URL: $CI_PIPELINE_URL"
  needs:
    - trigger_frontend_web_pipeline
    - trigger_backend_web_pipeline
    - trigger_embedded_sensor_pipeline
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: on_success
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      when: on_success
    - if: $CI_MERGE_REQUEST_IID
      when: on_success
