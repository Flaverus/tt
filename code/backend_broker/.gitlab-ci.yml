# Build a Docker image with CI/CD and push to the GitLab registry.
# Docker-in-Docker documentation: https://docs.gitlab.com/ci/docker/using_docker_build/
#
# This template uses generic jobs for build and test stages.

stages:
  - build

docker-build:
  image: docker:cli
  stage: build
  services:
    - docker:dind
  variables:
    DOCKER_IMAGE_NAME: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
    DOCKER_DRIVER: overlay2 # optional, can improve performance
    DOCKER_BUILDKIT: 1 # Add caching to speed up builds
  before_script: |
    echo "Logging in to GitLab Container Registry..."
    docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    echo "Login successful!"
  script: |
    echo "Building Docker image: $DOCKER_IMAGE_NAME from code/backend_broker/Dockerfile"
    docker build --pull -t "$DOCKER_IMAGE_NAME" -f code/backend_broker/Dockerfile code/backend_broker
    echo "Docker build completed. Pushing image to GitLab Container Registry..."
    docker push "$DOCKER_IMAGE_NAME"
    echo "Image pushed successfully."
    if [[ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]]; then
      echo "On default branch ($CI_DEFAULT_BRANCH). Tagging as latest..."
      docker tag "$DOCKER_IMAGE_NAME" "$CI_REGISTRY_IMAGE:latest"
      docker push "$CI_REGISTRY_IMAGE:latest"
      echo "Latest tag pushed successfully."
    fi
  rules:
    - if: $CI_COMMIT_BRANCH
      exists:
        - code/backend_broker/Dockerfile
